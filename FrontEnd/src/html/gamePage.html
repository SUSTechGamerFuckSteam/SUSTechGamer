<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="../css/gamePage.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script rel="text/javascript" src="../script/ServerInteraction.js"></script>
</head>

<body>
    <div id="vueDiv" v-cloak>
        <div id="headerDiv">
            <a style="margin-left: 20px;">first | </a>
            <a>first ad| </a>
            <a>first | </a>
            <a>first | </a>
            <a style="margin-left: 1170px;">sign-in</a>
            <a>sign-up</a>
        </div>
        <div style="height:100px;"></div>
        <div id="gameDetailDiv">
            <div id="gameVideoDiv">
                <video width="100%" controls autoplay>
                        <source src="../Video/OYH.mp4" type="video/mp4">   
                        您的浏览器不支持 video 属性。
                      </video>
            </div>
            <div id="gameGetDiv">
                <div id="priceDiv">
                    <p style="font-size: 45px;height:70px;width:200px;margin: 0 auto;">{{'$'+price}}</p>
                    <span style="font-size: 15px;">{{discount}}</span>
                </div>
                <a v-on:click.prevent="purchaseGame" class="button" href="#" style="width:180px;height:60px;margin: 20px auto;font-size: 30px;font-weight: bold; line-height: 60px;">Purchase</a>
                <a class="button" href="#downloadBranch" style="width:180px;height:60px;margin: 20px auto;font-size: 30px;font-weight: bold; line-height: 60px;">Download</a>
            </div>
            <textarea id="gameDescription" style="resize: none;width:77%;height:150px;">{{gameDescription}}</textarea>
            <a class="button" v-on:click.prevent="purchaseGame" href="#" style="width:180px;height:60px;margin-top:70px;margin-left:30px;font-size: 30px;font-weight: bold;display: block;float: left;color: white;line-height: 60px;">Community</a>
        </div>
        <div id="gamePictureDiv" style="position: relative;">
            <p id="downloadBranch" class="clasify">
                <span id="reminder">Screenshots</span>
            </p>
            <div class="inlineDiv" style="margin-left: 0px;"></div>
            <div class="inlineDiv"></div>
            <div class="inlineDiv"></div>
            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 1000px;text-align: center;">
                <a v-on:click.prevent="" class="button" href="#" style="margin: 0px;">&lt</a>
            </div>
            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 30px;text-align: center;">
                <a v-on:click.prevent="" class="button" href="#" style="margin: 0px;">&gt</a>
            </div>


            <p class="clasify">
                <span id="reminder">Branches</span>
            </p>
            <div class="branchDiv" v-for="(branch,index) in branches" v-if="(index>=branchIndex&&index<branchIndex+3)?true:false">
                <textarea class="branchInfo" resizable="false">{{branch.info}}</textarea>
                <a class="button" href="http://10.21.100.129:9090/download?uid=1&gid=8" style="margin: 45px 20px;width:110px;float: left;display: inline-block;">download</a>
            </div>

            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 1000px;text-align: center;">
                <a v-on:click.prevent="prevBranch" class="button" href="#" style="margin: 0px;">&lt</a>
            </div>
            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 30px;text-align: center;">
                <a v-on:click.prevent="nextBranch" class="button" href="" style="margin: 0px;">&gt</a>
            </div>

            <p class="clasify">
                <span id="reminder">DLCs</span>
            </p>
            <div class="branchDiv">
                <textarea class="branchInfo" resizable="false">{{test}}</textarea>
                <div style="float: left;width:110px;height:25px;font-size: 20px;text-align: center;">$120</div>
                <a v-on:click.prevent="" class="button" href="#" style="margin: 5px 20px;width:110px;float: left;display: inline-block;font-size: 20px;">purchase</a>
                <a v-on:click.prevent="" class="button" href="#" style="margin: 0px 20px;width:110px;float: left;display: inline-block;font-size: 18px;">download</a>
            </div>
            <div class="branchDiv">
                <textarea class="branchInfo" resizable="false">{{test}}</textarea>
                <a v-on:click.prevent="" class="button" href="#" style="margin: 45px 20px;width:110px;float: left;display: inline-block;">download</a>
            </div>
            <div class="branchDiv">
                <textarea class="branchInfo" resizable="false">{{test}}</textarea>
                <a v-on:click.prevent="" class="button" href="#" style="margin: 45px 20px;width:110px;float: left;display: inline-block;">download</a>
            </div>

            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 1000px;text-align: center;">
                <a v-on:click.prevent="" class="button" href="#" style="margin: 0px;">&lt</a>
            </div>
            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 30px;text-align: center;">
                <a v-on:click.prevent="" class="button" href="#" style="margin: 0px;">&gt</a>
            </div>

        </div>

        <div id="gameCommentDiv" style="position: relative;">
            <p class="clasify">
                <span id="reminder">Comments</span>
            </p>
            <div id="scoreDiv">
                <div style="width: 150px;height:100px;display:inline-block;font-size: 70px;margin-left: 70px;margin-top: 25px;text-align: center;">
                    4.5
                </div>
                <span style="font-family: 微软雅黑, 宋体, Arial, Helvetica, Verdana, sans-serif;font-weight: lighter;font-size: 25px;">
                    points ranked by users
                </span>
            </div>
            <div class="userCommentDiv" v-for="(comment,index) in commentList">
                <div style="float: left;width:150px;height:150px;position: relative;">
                    <img v-bind:src="comment.avatarUrl" style="display:block;width:100px;height:80px;position: absolute;top:0px;left:25px;">
                    <a href="userPage.html" style="position: absolute;width:150px;height:150px;"></a>
                    <span style="position: absolute;top:90px;left:15px;font-size: 20px;">{{comment.userName}}</span>
                    <span style="position: absolute;top:110px;left:15px;font-size: 20px;">{{comment.points}}</span>
                </div>
                <textarea style="width:750px;height:100px;margin-top:25px;margin-left:20px;background: #a1f5a1;resize: none;float: left;" readonly>{{comment.content}}</textarea>
                <!-- <div style="float: left;width:30px;height:30px;margin-top: 100px;margin-left: 20px;position: relative;">
                    <img src="../../figures/icon/like.png" style="width:30px;height:30px;position:absolute;">
                    <a v-on:click.prevent="purchaseGame" href="#" style="width:30px;height:30px;z-index: 3;position: absolute;opacity: 0;"></a>
                </div>
                <div style="float: left;width:30px;height:30px;margin-top: 100px;margin-left: 10px;position: relative;">
                    <img src="../../figures/icon/dislike.png" style="width:30px;height:30px;position:absolute;">
                    <a v-on:click.prevent="purchaseGame" href="#" style="width:30px;height:30px;z-index: 3;position: absolute;opacity: 0;"></a>
                </div> -->
                <a v-on:click.prevent="purchaseGame" class="button" href="#" style="width:90px;height:30px;margin-top:100px;margin-left:20px;font-size: 20px;font-weight: bold;float: left;line-height: 30px;">see more</a>
            </div>

            <textarea style="width:920px;height:100px;margin-top: 20px;margin-left:10px;resize: none;float: left;" placeholder="leave your comment and picture here (need purchase first)" v-model="userComment"></textarea>
            <label style="float: left;width:100px;font-size:15px;margin-top:20px;font-weight: bold;">rank the game</label>
            <select v-model="userPoint" style="float: left;margin-top:20px;">
                <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
            </select>
            <input type="file" id="u" v-on:change="pictureComment($event)" capture="camera" accept="image/*" style="margin-top:20px;margin-left:20px;width:110px;cursor:pointer;font-size: 17px;float: left;" title="picture" />
            <a v-on:click.prevent="sendComment" class="button" href="#" style="margin-top:10px;margin-left:20px;margin-bottom:10px;width:110px;display: inline-block;font-size: 25px;float: left;">Comment</a>
            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 1000px;text-align: center;">
                <a v-on:click.prevent="prevBranch" class="button" href="#" style="margin: 0px;">&lt</a>
            </div>
            <div class="inlineDiv" style="width:30px;height:20px;margin-left: 30px;text-align: center;">
                <a v-on:click.prevent="nextBranch" class="button" href="#" style="margin: 0px;">&gt</a>
            </div>

        </div>
    </div>
</body>
<script>
    var vm = new Vue({
        el: '#vueDiv',
        data: {
            userBalance: 120,
            test: "hh\nnima\nhh",
            gameVideoUrl: "",
            price: "520",
            gameDescription: "this is the best game in SUSTech\nLOL!!!!!",
            screenshotsUrl: "",
            branches: [],
            DLCs: "",
            branchIndex: 0,
            discount: "(discount 87%, original $600)",
            uid: 1,
            gid: 6,
            userComment: "",
            commentList: [{
                avatarUrl: "",
                points: "gives 4.5 points",
                content: "lajiyouxi,chaping!",
                userName: "ShowMaker",
                uid: "",
                tid: "",
            }],
            fileObj: "",
            userPoint: 5,
        },
        created: function() {
            outThis = this
            var jsonObj = parsePageUrl(location.href)
            console.log(JSON.stringify(jsonObj))
            ajax("get", "http://10.21.100.129:9090/game/findPriceByGid?gid=6", null, true, function(x) {
                outThis.price = x.responseText
            })
            ajax("get", "http://10.21.100.129:9090/user/findBalanceByUid?uid=" + this.uid, null, true, function(x) {
                outThis.userBalance = x.responseText
            })
            ajax("get", "http://10.21.100.129:9090/game/findBranchBygid?id=8", null, true, function(x) {
                var JsonRe = JSON.parse(x.responseText)
                console.log(JsonRe)
                for (var obj in JsonRe) {
                    outThis.branches.push({
                        info: JsonRe[obj].description
                    })
                }
            })
            ajax("get", "http://10.21.100.129:9090/postbar/infoByGid?gid=8", null, true, function(x) {
                var jsonRe = JSON.parse(x.responseText)
                for (var obj in jsonRe) {
                    outThis.commentList.push({
                        avatarUrl: jsonRe[obj].user_picture,
                        points: "gives " + jsonRe[obj].points + " points",
                        content: jsonRe[obj].content,
                        userName: jsonRe[obj].name,
                        uid: jsonRe[obj].uid,
                        tid: jsonRe[obj].tid
                    })
                }
            })
        },
        methods: {
            nextBranch: function() {
                this.branchIndex += 3
            },
            prevBranch: function() {
                this.branchIndex -= 3
            },
            purchaseGame: function() {
                var purchasable = false
                ajax("get", "http://10.21.100.129:9090/dev_game/findBygidByuid?gid=" + this.gid + "&uid=" + this.uid, null, false, function(x) {
                    if (x.responseText == 0) {
                        purchasable = true
                    }
                })
                if (!purchasable) {
                    alert("you have purchased already")
                    return
                }
                if (this.userBalance < this.price) {
                    alert("your balance is not enough")
                    return
                }
                ajax("get", "http://10.21.100.129:9090/dev_game/buyByuidBygid?uid=" + this.uid + "&gid=" + this.gid, null, false, function(x) {
                    if (x.responseText == 1) {
                        alert("purchase successfully")
                    } else {
                        alert("purchase failed")
                    }

                })
                location.reload()
            },
            purchaseDLC: function() {

            },
            pictureComment: function(event) {
                var fileObj = event.target.files[0]
                this.fileObj = fileObj
            },
            sendComment: function() {
                var formData = new FormData()
                if (this.fileObj != null)
                    formData.append("picture", this.fileObj)
                formData.append("content", encodeURI(this.userComment))
                formData.append("gid", 8)
                formData.append("uid", 1)
                formData.append("points", this.userPoint)
                ajax("post", "http://10.21.100.129:9090/postbar/setupPostbar", formData, false, function(x) {
                    if (x.responseText == 1) {
                        alert("comment successfully")
                    } else {
                        alert("comment failed")
                    }
                })
            }
        }
    })
</script>

</html>